# This workflow will install Python dependencies, run tests and lint with a single version of Python

name: Python application

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    # 第一步：测试和代码质量检查
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4 # 将代码检出到vm
    - name: Set up Python 3.10  # vm 设置python 环境
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # 假设 requirements.txt 在根目录
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install flake8 pytest 

    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  # =======================================================
  # 第二步：打包 Linux (Ubuntu) 可执行文件
  # =======================================================
  pyinstaller-build-linux:
    needs: [build]
    runs-on: ubuntu-latest # 在 Linux 环境运行

    steps:
      - uses: actions/checkout@v4
      - name: Create Linux Executable
        uses: sayyid5416/pyinstaller@v1
        with:
          # 建议与测试环境保持一致
          python_ver: '3.10' 
          pyinstaller_ver: '==5.13.2'
          spec: 'main.py'
          requirements: 'requirements.txt'
          upload_exe_with_name: 'My App - Linux'
          # Linux 默认是命令行应用，如果需要图形界面，可加上 --windowed
          options: --onefile, --name "MyApp-Linux"

  # =======================================================
  # 第三步：打包 macOS 可执行文件 (生成 .app 或 Unix Exec)
  # =======================================================
  pyinstaller-build-mac:
    needs: [build]
    runs-on: macos-latest # 在 macOS 环境运行

    steps:
      - uses: actions/checkout@v4
      - name: Create macOS Executable
        uses: sayyid5416/pyinstaller@v1
        with:
          # 建议与测试环境保持一致
          python_ver: '3.10' 
          pyinstaller_ver: '==5.13.2'
          spec: 'main.py'
          requirements: 'requirements.txt'
          upload_exe_with_name: 'My App - macOS'
          # macOS 打包时，通常需要 --windowed 才能生成用户友好的 .app 结构
          options: --onefile, --name "MyApp-macOS" 

  # =======================================================
  # (可选) 第四步：打包 Windows 可执行文件 (保留原有的)
  # =======================================================
  pyinstaller-build-win:
    needs: [build]
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
      - name: Create Windows Executable
        uses: sayyid5416/pyinstaller@v1
        with:
          python_ver: '3.10' # 统一版本
          pyinstaller_ver: '==5.13.2'
          spec: 'main.py'
          requirements: 'requirements.txt'
          upload_exe_with_name: 'My App - Windows'
          options: --onefile, --name "MyApp-Windows"
